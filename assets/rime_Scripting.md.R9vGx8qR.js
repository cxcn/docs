import{_ as t,c as s,o as i,U as a}from"./chunks/framework.WKpLpN6N.js";const y=JSON.parse('{"title":"脚本开发指南","description":"","frontmatter":{},"headers":[],"relativePath":"rime/Scripting.md","filePath":"librime-lua.wiki/Scripting.md"}'),e={name:"rime/Scripting.md"},d=a(`<h1 id="脚本开发指南" tabindex="-1">脚本开发指南 <a class="header-anchor" href="#脚本开发指南" aria-label="Permalink to &quot;脚本开发指南&quot;">​</a></h1><p>librime-lua 是 RIME 输入法引擎的一个插件，它为用户提供了使用 lua 脚本语言扩展输入法的能力。通过 lua，您可以实现输入任意动态短语（如日期时间、大写数字、计算器）、自由重排/过滤候选词，甚至云输入等，单纯使用配置文件难以做到的，灵活多样的功能。本文将介绍本项目的配置和编程方法。</p><p>要理解本项目的工作原理，需先了解 RIME 功能组件的基本概念与工作流程，见<a href="https://github.com/rime/home/wiki/RimeWithSchemata#%E8%BC%B8%E5%85%A5%E6%B3%95%E5%BC%95%E6%93%8E%E8%88%87%E5%8A%9F%E8%83%BD%E7%B5%84%E4%BB%B6" target="_blank" rel="noreferrer">RIME文档</a>。简而言之，librime-lua 提供了 processor、segmentor、translator 和 filter 这四个功能组件的开发接口。下面首先通过一个例子来说明完整的流程，然后再详细介绍各个组件的编程接口。</p><h2 id="例子-输入今天的日期" tabindex="-1">例子：输入今天的日期 <a class="header-anchor" href="#例子-输入今天的日期" aria-label="Permalink to &quot;例子：输入今天的日期&quot;">​</a></h2><p>我们通过“输入今天的日期”这个例子，来说明开发定制的流程。一共分三步：编写代码、配置方案、重新部署。</p><h3 id="编写代码" tabindex="-1">编写代码 <a class="header-anchor" href="#编写代码" aria-label="Permalink to &quot;编写代码&quot;">​</a></h3><p>输入日期，需要用到 translator。我们希望在输入“date”之后，在输入法候选框中得到今天日期。我们在 RIME 的用户目录下新建一个 <code>rime.lua</code> 文件，这是整个 lua 脚本的总入口。在文件中录入以下内容：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> date_translator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input, seg)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;date&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      --- Candidate(type, start, end, text, comment)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      yield</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Candidate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;date&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, seg.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, seg.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">_end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">os.date</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;%Y年%m月%d日&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; 日期&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>上面实现了一个叫做 <code>date_translator</code> 的函数。它的输入是 <code>input</code> 和 <code>seg</code>，分别记录了 translator 需要翻译的内容和它在输入串中的位置。这个函数会判断输入的是否是“date”。如是则生成一个内容为今天日期的候选项。候选项的构造函数是 <code>Candidate</code>。这个函数如注释所说有五个参数：类型、开始位置、结束位置、候选内容和候选注释。类型可以是任意字符串，这里用了<code>&quot;date&quot;</code>；开始、结束位置一般用 <code>seg.start</code> 和 <code>seg._end</code> 就可以，它表示了我们要将整个待翻译的输入串替换为候选内容；候选内容是使用 lua 的库函数生成的日期；候选注释一般会在输入候选框中以灰色展示在候选内容旁边。候选项生成以后是通过 <code>yield</code> 发出的。<code>yield</code> 在这里可以简单理解为“发送一个候选项到候选框中”。一个函数可以 <code>yield</code> 任意次，这里我们只有一个候选项所以只有一个 <code>yield</code>。</p><h3 id="配置方案" tabindex="-1">配置方案 <a class="header-anchor" href="#配置方案" aria-label="Permalink to &quot;配置方案&quot;">​</a></h3><p>我们已经编写了输入日期的 translator，为了让它生效，需要修改输入方案的配置文件。以明月拼音为例，找到 <code>luna_pinyin.schema.yaml</code>，在 <code>engine/translators</code> 中加入一项 <code>lua_translator@date_translator</code>，如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>engine:</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span>  translators:</span></span>
<span class="line"><span>    - lua_translator@date_translator</span></span>
<span class="line"><span>    ...</span></span></code></pre></div><p>这样就完成了配置。它表示从 lua 执行环境中找到名为 <code>date_translator</code> 的全局实例，将它作为一种 translator 安装到引擎之中。其他类型的组件配置类推，分别叫做 <code>lua_processor</code> <code>lua_segmentor</code> <code>lua_filter</code>。</p><h3 id="重新部署" tabindex="-1">重新部署 <a class="header-anchor" href="#重新部署" aria-label="Permalink to &quot;重新部署&quot;">​</a></h3><p>以上完成了所有开发和配置。点击“重新部署”，输入&quot;date&quot;，就可以看到候选框中出现了今天的日期。</p><p>在本项目的 <code>sample</code> 目录下，还有更多的例子。配合其中的注释并稍加修改，就可以满足大部分的日常需求。</p><h3 id="模块化" tabindex="-1">模块化 <a class="header-anchor" href="#模块化" aria-label="Permalink to &quot;模块化&quot;">​</a></h3><p>到目前为止，我们的代码完全集中在 <code>rime.lua</code> 中。本节说明 librime-lua 对模块化的支持。模块化是指把脚本分门别类，放到独立的文件中，避免各自的修改互相干扰，也方便把自己的作品分享给他人使用。仍然以 <code>date_translator</code> 为例。</p><h4 id="分离脚本内容" tabindex="-1">分离脚本内容 <a class="header-anchor" href="#分离脚本内容" aria-label="Permalink to &quot;分离脚本内容&quot;">​</a></h4><p>首先需要把原来写在 <code>rime.lua</code> 的脚本搬运到独立的文件中。删掉 <code>rime.lua</code> 原有的内容后，在 RIME 的用户目录下新建一个 <code>lua</code> 目录，在 <code>lua</code> 下再建立一个 <code>date_translator.lua</code> 文件，录入以下内容：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> translator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input, seg)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;date&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      --- Candidate(type, start, end, text, comment)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      yield</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Candidate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;date&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, seg.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, seg.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">_end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">os.date</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;%Y年%m月%d日&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; 日期&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> translator</span></span></code></pre></div><p>可以看到主要内容与之前一致，但有两点不同：</p><ul><li>使用 <code>local</code>。lua 脚本的变量作用域默认是全局的。如果不同模块的变量或函数正好用了相同的名字，就会导致互相干扰，出现难以排查的问题。因此，尽量使用 <code>local</code> 把变量作用域限制在局部。</li><li>新增 <code>return</code>。librime-lua 是借助 lua 的 require 机制实现模块加载。引用模块时，整个文件被当作一个函数执行，返回模块内容。在这里返回的是一个 translator 组件。</li></ul><h4 id="引用模块" tabindex="-1">引用模块 <a class="header-anchor" href="#引用模块" aria-label="Permalink to &quot;引用模块&quot;">​</a></h4><p>我们已经建立了一个名叫 <code>date_translator</code> 的模块。接下来是引用。</p><h5 id="旧版-librime-lua" tabindex="-1">旧版 librime-lua <a class="header-anchor" href="#旧版-librime-lua" aria-label="Permalink to &quot;旧版 librime-lua&quot;">​</a></h5><p>如果使用的是较旧的 librime-lua，仍然需要在 <code>rime.lua</code> 内输入以下内容：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">date_translator </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;date_translator&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>前一个 <code>date_translator</code> 是全局变量名，后一个是模块名。librime-lua 将 RIME 的用户目录和 RIME 共享目录下的 <code>lua</code> 目录加入了模块搜索路径，因此本句的意义是搜索 <code>date_translator</code> 模块，并将返回的组件绑定到同名的全局变量上。这样就可以在输入方案配置文件中使用了，方法与之前一致。</p><h5 id="新版-librime-lua" tabindex="-1">新版 librime-lua <a class="header-anchor" href="#新版-librime-lua" aria-label="Permalink to &quot;新版 librime-lua&quot;">​</a></h5><p>如果使用的是最新的 librime-lua，则可以进一步避免修改 <code>rime.lua</code>，达到真正的模块化。</p><p>方法是将输入方案配置文件中直接写入以下内容：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>engine:</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span>  translators:</span></span>
<span class="line"><span>    - lua_translator@*date_translator</span></span>
<span class="line"><span>  ...</span></span></code></pre></div><p>与之前的区别是第一个 <code>@</code> 之后多了一个 <code>*</code>。这个星号表示后面的名字是模块名而不是全局变量名。当遇到星号时，librime-lua 会在内部先使用 require 机制加载模块，然后将其返回值作为 RIME 组件加载到输入法框架中。</p><h4 id="配方补丁" tabindex="-1">配方补丁 <a class="header-anchor" href="#配方补丁" aria-label="Permalink to &quot;配方补丁&quot;">​</a></h4><p>以上我们实现了 lua 脚本的模块化。但为引用组件，仍需修改输入配方。为使对配方文件修改的模块化，请见<a href="https://github.com/rime/home/wiki/Configuration#%E8%A3%9C%E9%9D%AA" target="_blank" rel="noreferrer">RIME配方补丁</a>。</p><h2 id="编程接口" tabindex="-1">编程接口 <a class="header-anchor" href="#编程接口" aria-label="Permalink to &quot;编程接口&quot;">​</a></h2><p>本节详细介绍编程接口。需注意随着项目的开发，以下文档可能是不完整或过时的，敬请各位参与贡献文档。</p><h3 id="lua-translator" tabindex="-1"><code>lua_translator</code> <a class="header-anchor" href="#lua-translator" aria-label="Permalink to &quot;\`lua_translator\`&quot;">​</a></h3><p><code>lua_translator</code> 提供了 translator 的开发接口。它在配置文件中的配置语法有两种，分别是：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>engine:</span></span>
<span class="line"><span>  translators:</span></span>
<span class="line"><span>    - lua_translator@lua_object_name</span></span>
<span class="line"><span>    - lua_translator@lua_object_name@name_space</span></span></code></pre></div><p>其中 <code>lua_object_name</code> 是 lua 环境中的一个全局对象，可能是一个 lua function 或者一个 lua table。后面的 <code>name_space</code> 当出现时是 translator 名字，与 RIME 组件配置中出现的 <code>@</code> 意义一致。</p><p><code>lua_object_name</code> 所指对象有多种形式：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">--- 简化形式1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> translator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input, seg)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">--- 简化形式2</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> translator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input, seg, env)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">--- 完整形式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   init</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (env) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   func</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (input, seg, env) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   fini</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (env) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>简化形式是 lua function，此函数即为 translator 的工作函数。无返回值。可以通过 <code>yield</code> 发送 <code>Candidate</code> 对象。 参数：</p><ul><li><code>input</code>：字符串，为待翻译串。</li><li><code>seg</code>：<code>Segment</code> 对象。</li><li><code>env</code>：lua table 对象。预设 <code>engine</code> 和 <code>name_space</code> 两个成员，分别是 <code>Engine</code> 对象和前述 <code>name_space</code> 配置字符串。</li></ul><p>完整形式是 lua table，其中 <code>func</code> 与简化形式意义相同。<code>init</code> 与 <code>fini</code> 分别在 <code>lua_translator</code> 构造与析构时调用。</p><h3 id="lua-filter" tabindex="-1"><code>lua_filter</code> <a class="header-anchor" href="#lua-filter" aria-label="Permalink to &quot;\`lua_filter\`&quot;">​</a></h3><p><code>lua_filter</code> 提供了 filter 的开发接口。它在配置文件中的配置语法有两种，分别是：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>engine:</span></span>
<span class="line"><span>  filters:</span></span>
<span class="line"><span>    - lua_filter@lua_object_name</span></span>
<span class="line"><span>    - lua_filter@lua_object_name@name_space</span></span></code></pre></div><p>其中 <code>lua_object_name</code> 是 lua 环境中的一个全局对象，可能是一个 lua function 或者一个 lua table。后面的 <code>name_space</code> 当出现时是 filter 名字，与 RIME 组件配置中出现的 <code>@</code> 意义一致。</p><p><code>lua_object_name</code> 所指对象有多种形式：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">--- 简化形式1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">--- 简化形式2</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input, env)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">--- 简化形式3</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input, env, cands)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">--- 完整形式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   init</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (env) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   func</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (input, env) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   fini</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (env) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   tags_match</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (segment, env) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  --- 可选</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>简化形式是 lua function，此函数即为 filter 的工作函数。无返回值。可以通过 <code>yield</code> 发送 <code>Candidate</code> 对象。 参数：</p><ul><li><code>input</code>：<code>Translation</code> 对象，为待过滤的 <code>Candidate</code> 流。</li><li><code>env</code>：lua table 对象。预设 <code>engine</code> 和 <code>name_space</code> 两个成员，分别是 <code>Engine</code> 对象和前述 <code>name_space</code> 配置字符串。</li></ul><p>完整形式是 lua table，其中 <code>func</code> 与简化形式意义相同。<code>init</code> 与 <code>fini</code> 分别在 <code>lua_filter</code> 构造与析构时调用。<code>tags_match</code> 出现时覆盖 filter 的 <code>TagsMatch</code> 方法。</p><h3 id="lua-processor" tabindex="-1"><code>lua_processor</code> <a class="header-anchor" href="#lua-processor" aria-label="Permalink to &quot;\`lua_processor\`&quot;">​</a></h3><p><code>lua_processor</code> 提供了 processor 的开发接口。它在配置文件中的配置语法有两种，分别是：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>engine:</span></span>
<span class="line"><span>  processors:</span></span>
<span class="line"><span>    - lua_processor@lua_object_name</span></span>
<span class="line"><span>    - lua_processor@lua_object_name@name_space</span></span></code></pre></div><p>其中 <code>lua_object_name</code> 是 lua 环境中的一个全局对象，可能是一个 lua function 或者一个 lua table。后面的 <code>name_space</code> 当出现时是 processor 名字，与 RIME 组件配置中出现的 <code>@</code> 意义一致。</p><p><code>lua_object_name</code> 所指对象有多种形式：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">--- 简化形式1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key_event)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">--- 简化形式2</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key_event, env)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">--- 完整形式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   init</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (env) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   func</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (key_event, env) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   fini</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (env) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>简化形式是 lua function，此函数即为 processor 的工作函数。返回值为整数：</p><ul><li>0 表示 <code>kRejected</code> 字符上屏，结束 processors 流程</li><li>1 表示 <code>kAccepted</code> 字符不上屏，结束 processors 流程</li><li>2 表示 <code>kNoop</code> 字符不上屏，交给下一个 processor</li></ul><p>参数：</p><ul><li><code>key_event</code>：<code>KeyEvent</code> 对象，为待处理的按键。</li><li><code>env</code>：lua table 对象。预设 <code>engine</code> 和 <code>name_space</code> 两个成员，分别是 <code>Engine</code> 对象和前述 <code>name_space</code> 配置字符串。</li></ul><p>完整形式是 lua table，其中 <code>func</code> 与简化形式意义相同。<code>init</code> 与 <code>fini</code> 分别在 <code>lua_processor</code> 构造与析构时调用。</p><h3 id="lua-segmentor" tabindex="-1"><code>lua_segmentor</code> <a class="header-anchor" href="#lua-segmentor" aria-label="Permalink to &quot;\`lua_segmentor\`&quot;">​</a></h3><p><code>lua_segmentor</code> 提供了 segmentor 的开发接口。它在配置文件中的配置语法有两种，分别是：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>engine:</span></span>
<span class="line"><span>  segmentors:</span></span>
<span class="line"><span>    - lua_segmentor@lua_object_name</span></span>
<span class="line"><span>    - lua_segmentor@lua_object_name@name_space</span></span></code></pre></div><p>其中 <code>lua_object_name</code> 是 lua 环境中的一个全局对象，可能是一个 lua function 或者一个 lua table。后面的 <code>name_space</code> 当出现时是 segmentor 名字，与 RIME 组件配置中出现的 <code>@</code> 意义一致。</p><p><code>lua_object_name</code> 所指对象有多种形式：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">--- 简化形式1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> segmentor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(segmentation)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">--- 简化形式2</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> segmentor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(segmentation, env)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">--- 完整形式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   init</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (env) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   func</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (segmentation, env) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   fini</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (env) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>简化形式是 lua function，此函数即为 segmentor 的工作函数。返回值为bool（true: 交由下一个segmentor处理；false: 终止segmentors处理流程）。 参数：</p><ul><li><code>segmentation</code>：<code>Segmentation</code> 对象。</li><li><code>env</code>：lua table 对象。预设 <code>engine</code> 和 <code>name_space</code> 两个成员，分别是 <code>Engine</code> 对象和前述 <code>name_space</code> 配置字符串。</li></ul><p>完整形式是 lua table，其中 <code>func</code> 与简化形式意义相同。<code>init</code> 与 <code>fini</code> 分别在 <code>lua_segmentor</code> 构造与析构时调用。</p><h2 id="对象接口" tabindex="-1">对象接口 <a class="header-anchor" href="#对象接口" aria-label="Permalink to &quot;对象接口&quot;">​</a></h2><p>librime-lua 封装了 librime C++ 对象到 lua 中供脚本访问。此部分文档待整理。</p><h3 id="engine" tabindex="-1">Engine <a class="header-anchor" href="#engine" aria-label="Permalink to &quot;Engine&quot;">​</a></h3><p>可通过 <code>env.engine</code> 获得。</p><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>schema</td><td></td><td></td></tr><tr><td>context</td><td>Context</td><td></td></tr><tr><td>active_engine</td><td></td><td></td></tr></tbody></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>process_key</td><td></td><td></td><td></td></tr><tr><td>compose</td><td></td><td></td><td></td></tr><tr><td>commit_text(text)</td><td>text: string</td><td></td><td>上屏 text 字符串</td></tr><tr><td>apply_schema</td><td></td><td></td><td></td></tr></tbody></table><h3 id="context" tabindex="-1">Context <a class="header-anchor" href="#context" aria-label="Permalink to &quot;Context&quot;">​</a></h3><p>输入编码上下文。</p><p>可通过 <code>env.engine.context</code> 获得。 ( *W : 觸發 Compose() )</p><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>composition</td><td>Composition</td><td></td></tr><tr><td>input</td><td>string</td><td>*W 正在输入的编码字符串</td></tr><tr><td>caret_pos</td><td>number</td><td>*W 脱字符位置</td></tr><tr><td>commit_notifier</td><td>Notifier</td><td></td></tr><tr><td>select_notifier</td><td>Notifier</td><td></td></tr><tr><td>update_notifier</td><td>Notifier</td><td></td></tr><tr><td>delete_notifier</td><td>Notifier</td><td></td></tr><tr><td>option_update_notifier</td><td>OptionUpdateNotifier</td><td>选项改变通知，使用 connect 方法接收通知</td></tr><tr><td>property_update_notifier</td><td>PropertyUpdateNotifier</td><td></td></tr><tr><td>unhandled_key_notifier</td><td>KeyEventNotifier</td><td></td></tr></tbody></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>commit</td><td></td><td></td><td>上屏选中的候选词</td></tr><tr><td>get_commit_text</td><td></td><td>string</td><td></td></tr><tr><td>get_script_text</td><td></td><td>string</td><td>按音节分割</td></tr><tr><td>get_preedit</td><td></td><td>Preedit</td><td></td></tr><tr><td>is_composing</td><td></td><td>boolean</td><td>是否有未上屏的编码</td></tr><tr><td>has_menu</td><td></td><td>boolean</td><td>是否有候选词（选项菜单）</td></tr><tr><td>get_selected_candidate</td><td></td><td>Candidate</td><td>返回选中的候选词</td></tr><tr><td>push_input(text)</td><td>text: string</td><td></td><td>*W 在caret_pos位置插入指定的text编码字符串，caret_pos跟隨右移</td></tr><tr><td>pop_input(num)</td><td>num: number</td><td>boolean</td><td>*W 在caret_pos位置往左删除num指定数量的编码字符串，caret_pos跟隨左移</td></tr><tr><td>delete_input</td><td></td><td></td><td></td></tr><tr><td>clear</td><td></td><td></td><td>*W 清空正在输入的编码字符串</td></tr><tr><td>select(index)</td><td>index: number</td><td>boolean</td><td>选择下标候选词（下标0开始）</td></tr><tr><td>confirm_current_selection</td><td></td><td></td><td></td></tr><tr><td>delete_current_selection</td><td></td><td>boolean</td><td>是否有候选词（this doesn&#39;t mean anything is deleted for sure） <br> <a href="https://github.com/rime/librime/blob/fbe492eefccfcadf04cf72512d8548f3ff778bf4/src/context.cc#L125-L137" target="_blank" rel="noreferrer">https://github.com/rime/librime/.../src/context.cc#L125-L137</a></td></tr><tr><td>confirm_previous_selection</td><td></td><td></td><td></td></tr><tr><td>reopen_previous_selection *W</td><td></td><td></td><td></td></tr><tr><td>clear_previous_segment</td><td></td><td></td><td></td></tr><tr><td>reopen_previous_segment *W</td><td></td><td></td><td></td></tr><tr><td>clear_non_confirmed_composition</td><td></td><td></td><td></td></tr><tr><td>refresh_non_confirmed_composition *W</td><td></td><td></td><td></td></tr><tr><td>set_option</td><td></td><td></td><td></td></tr><tr><td>get_option</td><td></td><td></td><td></td></tr><tr><td>set_property(key, value)</td><td>key: string <br> value: string</td><td></td><td>可以用于存储上下文信息（可配合 <code>property_update_notifier</code> 使用）</td></tr><tr><td>get_property(key)</td><td>key: string</td><td>string</td><td></td></tr><tr><td>clear_transient_options</td><td></td><td></td><td></td></tr></tbody></table><h3 id="preedit" tabindex="-1">Preedit <a class="header-anchor" href="#preedit" aria-label="Permalink to &quot;Preedit&quot;">​</a></h3><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>text</td><td></td><td></td></tr><tr><td>caret_pos</td><td></td><td></td></tr><tr><td>sel_start</td><td></td><td></td></tr><tr><td>sel_end</td><td></td><td></td></tr></tbody></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead></table><h3 id="composition" tabindex="-1">Composition <a class="header-anchor" href="#composition" aria-label="Permalink to &quot;Composition&quot;">​</a></h3><p>上下文组成的“作品”。（通过此对象，可间接获得“菜单menu”、“候选词candidate”、“片段segment”相关信息）</p><p>可通过 <code>env.engine.context.composition</code> 获得。</p><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>empty</td><td></td><td>boolean</td><td>是否有候选词（是否有menu）</td></tr><tr><td>back</td><td></td><td>Segment</td><td>获得 Segment 对象</td></tr><tr><td>pop_back</td><td></td><td></td><td></td></tr><tr><td>push_back</td><td></td><td></td><td></td></tr><tr><td>has_finished_composition</td><td></td><td></td><td></td></tr><tr><td>get_prompt</td><td></td><td>string</td><td>获得 Segment 的 prompt 字符串（prompt 为活动编码左边的字符串提示）</td></tr><tr><td>toSegmentation</td><td></td><td></td><td></td></tr></tbody></table><p>e.g.</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> composition </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> env.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">engine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">composition</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">not</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> composition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">empty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- 获得 Segment 对象</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> segment </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> composition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">back</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- 获得选中的候选词下标</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> selected_candidate_index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> segment.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">selected_index</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- 获取 Menu 对象</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> menu </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> segment.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">menu</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- 获得（已加载）候选词数量</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> loaded_candidate_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> menu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">candidate_count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="segmentation" tabindex="-1">Segmentation <a class="header-anchor" href="#segmentation" aria-label="Permalink to &quot;Segmentation&quot;">​</a></h3><p>在分词处理流程 Segmentor 中存储 Segment 并把其传递给 Translator 进行下一步翻译处理。</p><p>作为第一个参数传入以注册的 lua_segmentor。</p><p>或通过以下方法获得：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> composition </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> env.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">engine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">composition</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> segmentation </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> composition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">toSegmentation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><blockquote><p>librime 定义 - <a href="https://github.com/rime/librime/blob/5c36fb74ccdff8c91ac47b1c221bd7e559ae9688/src/segmentation.cc#L28" target="_blank" rel="noreferrer">https://github.com/rime/librime/blob/5c36fb74ccdff8c91ac47b1c221bd7e559ae9688/src/segmentation.cc#L28</a></p></blockquote><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>input</td><td>string</td><td>活动中的原始（未preedit）输入编码</td></tr></tbody></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>empty</td><td></td><td>boolean</td><td>是否包含 Segment</td></tr><tr><td>back</td><td></td><td>Segment</td><td>查看添加的 Segment</td></tr><tr><td>pop_back</td><td></td><td>Segment</td><td>查看最近添加的 Segment，并将其从 Segmentation 中移除</td></tr><tr><td>reset_length</td><td></td><td></td><td></td></tr><tr><td>add_segment(seg)</td><td>seg: Segment</td><td></td><td>添加 Segment <br>（librime v1.7.3：如果已包含 Segment，仅将新 Segment.tags 合并入旧 Segment.tags）</td></tr><tr><td>forward</td><td></td><td></td><td></td></tr><tr><td>trim</td><td></td><td></td><td>清空其中的 Segment</td></tr><tr><td>has_finished_segmentation</td><td></td><td>boolean</td><td></td></tr><tr><td>get_current_start_position</td><td></td><td>number</td><td></td></tr><tr><td>get_current_end_position</td><td></td><td>number</td><td></td></tr><tr><td>get_current_segment_length</td><td></td><td>number</td><td></td></tr><tr><td>get_confirmed_position</td><td></td><td>number</td><td>属性 input 中已经确认（处理完）的长度 <br> （通过判断 status 为 &quot;kSelected&quot; 以上的 Segment 的 _end 来判断 confirmed_position） <br> <a href="https://github.com/rime/librime/blob/cea389e6eb5e90f5cd5b9ca1c6aae7a035756405/src/segmentation.cc#L127" target="_blank" rel="noreferrer">https://github.com/rime/librime/.../src/segmentation.cc#L127</a></td></tr></tbody></table><p>e.g.</p><div class="language-txt vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>                         | 你hao‸a</span></span>
<span class="line"><span>env.engine.context.input | &quot;nihaoa&quot;</span></span>
<span class="line"><span>Segmentation.input       | &quot;nihao&quot;</span></span>
<span class="line"><span>get_confirmed_position   | 2</span></span></code></pre></div><h3 id="segment" tabindex="-1">Segment <a class="header-anchor" href="#segment" aria-label="Permalink to &quot;Segment&quot;">​</a></h3><p>分词片段。触发 translator 时作为第二个参数传递给注册好的 lua_translator。</p><p>或者以下方法获得: （在 filter 以外的场景使用）</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> composition </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  env.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">engine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">composition</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">not</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> composition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">empty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> segment </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> composition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">back</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>构造方法：<code>Segment(start_pos, end_pos)</code></p><ol><li>start_pos: 开始下标</li><li>end_pos: 结束下标</li></ol><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>status</td><td>string</td><td>1. <code>kVoid</code> - （默认） <br> 2. <code>kGuess</code> <br> 3. <code>kSelected</code> - 大于此状态才会被视为选中 <br> 4. <code>kConfirmed</code></td></tr><tr><td>start</td><td></td><td></td></tr><tr><td>_start</td><td></td><td></td></tr><tr><td>_end</td><td></td><td></td></tr><tr><td>length</td><td></td><td></td></tr><tr><td>tags</td><td>Set</td><td>标签</td></tr><tr><td>menu</td><td></td><td></td></tr><tr><td>selected_index</td><td></td><td></td></tr><tr><td>prompt</td><td>string</td><td>输入编码旁的提示字符串 <br> <img src="https://user-images.githubusercontent.com/18041500/190980054-7e944f5f-a381-4c73-ad6a-254a00c09e44.png" alt="image"></td></tr></tbody></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>clear</td><td></td><td></td><td></td></tr><tr><td>close</td><td></td><td></td><td></td></tr><tr><td>reopen</td><td></td><td></td><td></td></tr><tr><td>has_tag</td><td></td><td></td><td></td></tr><tr><td>get_candidate_at(index)</td><td>index: number 下标0开始</td><td>Candidate</td><td></td></tr><tr><td>get_selected_candidate</td><td></td><td>Candidate</td><td></td></tr></tbody></table><h3 id="schema" tabindex="-1">Schema <a class="header-anchor" href="#schema" aria-label="Permalink to &quot;Schema&quot;">​</a></h3><p>方案。可以通过 <code>env.engine.schema</code> 获得。</p><p>构造方法：<code>Schema(schema_id)</code></p><ol><li>schema_id: string</li></ol><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>schema_id</td><td>string</td><td>方案编号</td></tr><tr><td>schema_name</td><td>string</td><td>方案名称</td></tr><tr><td>config</td><td>Config</td><td>方案配置</td></tr><tr><td>page_size</td><td>number</td><td>每页候选词数</td></tr><tr><td>select_keys</td><td></td><td></td></tr></tbody></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead></table><h3 id="config" tabindex="-1">Config <a class="header-anchor" href="#config" aria-label="Permalink to &quot;Config&quot;">​</a></h3><p>（方案的）配置。可以通过 <code>env.engine.schema.config</code> 获得</p><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>load_from_file</td><td></td><td></td><td></td></tr><tr><td>save_to_file</td><td></td><td></td><td></td></tr><tr><td>is_null(conf_path)</td><td>conf_path: string</td><td></td><td></td></tr><tr><td>is_value</td><td></td><td></td><td></td></tr><tr><td>is_list(conf_path)</td><td>conf_path: string</td><td>boolean</td><td>1. 存在且为 ConfigList 返回 true <br> 2. 存在且不为 ConfigList 返回 false <br> 3. 不存在返回 true ⚠️</td></tr><tr><td>is_map</td><td></td><td></td><td></td></tr><tr><td>get_bool</td><td></td><td></td><td></td></tr><tr><td>get_int</td><td></td><td></td><td></td></tr><tr><td>get_double</td><td></td><td></td><td></td></tr><tr><td>get_string(conf_path)</td><td>conf_path: string</td><td>string</td><td>根据配置路径 conf_path 获取配置的字符串值</td></tr><tr><td>set_bool</td><td></td><td></td><td></td></tr><tr><td>set_int</td><td></td><td></td><td></td></tr><tr><td>set_double</td><td></td><td></td><td></td></tr><tr><td>set_string(path, str)</td><td>path: string <br> str: string</td><td></td><td></td></tr><tr><td>get_item</td><td></td><td></td><td></td></tr><tr><td>set_item(path, item)</td><td>path: string <br> item: ConfigItem</td><td></td><td></td></tr><tr><td>get_value</td><td></td><td></td><td></td></tr><tr><td>get_list(conf_path)</td><td>conf_path: string</td><td>ConfigList</td><td>不存在或不为 ConfigList 时返回 nil</td></tr><tr><td>get_map(conf_path)</td><td>conf_path: string</td><td>ConfigMap</td><td>不存在或不为 ConfigMap 时返回 nil</td></tr><tr><td>set_value(path, value)</td><td>path: string <br> value: ConfigValue</td><td></td><td></td></tr><tr><td>set_list</td><td></td><td></td><td></td></tr><tr><td>set_map</td><td></td><td></td><td></td></tr><tr><td>get_list_size</td><td></td><td></td><td></td></tr></tbody></table><h3 id="configmap" tabindex="-1">ConfigMap <a class="header-anchor" href="#configmap" aria-label="Permalink to &quot;ConfigMap&quot;">​</a></h3><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>size</td><td>number</td><td></td></tr><tr><td>type</td><td>string</td><td>如：“kMap”</td></tr><tr><td>element</td><td></td><td>轉換成ConfigItem</td></tr></tbody></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>set</td><td></td><td></td><td></td></tr><tr><td>get(key)</td><td>key: string</td><td>ConfigItem</td><td></td></tr><tr><td>get_value(key)</td><td>key: string</td><td>ConfigValue</td><td></td></tr><tr><td>has_key</td><td></td><td>boolean</td><td></td></tr><tr><td>clear</td><td></td><td></td><td></td></tr><tr><td>empty</td><td></td><td>boolean</td><td></td></tr><tr><td>keys</td><td></td><td>table</td><td></td></tr></tbody></table><h3 id="configlist" tabindex="-1">ConfigList <a class="header-anchor" href="#configlist" aria-label="Permalink to &quot;ConfigList&quot;">​</a></h3><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>size</td><td>number</td><td></td></tr><tr><td>type</td><td>string</td><td>如：“kList”</td></tr><tr><td>element</td><td></td><td>轉換成ConfigItem</td></tr></tbody></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>get_at(index)</td><td>index: number <br> （下标从0开始）</td><td>ConfigItem</td><td></td></tr><tr><td>get_value_at(index)</td><td>index: number <br> （下标从0开始）</td><td>ConfigValue</td><td></td></tr><tr><td>set_at</td><td></td><td></td><td></td></tr><tr><td>append</td><td></td><td></td><td></td></tr><tr><td>insert</td><td></td><td></td><td></td></tr><tr><td>clear</td><td></td><td></td><td></td></tr><tr><td>empty</td><td></td><td></td><td></td></tr><tr><td>resize</td><td></td><td></td><td></td></tr></tbody></table><h3 id="configvalue" tabindex="-1">ConfigValue <a class="header-anchor" href="#configvalue" aria-label="Permalink to &quot;ConfigValue&quot;">​</a></h3><p>继承 ConfigItem</p><p>构造方法：<code>ConfigValue(str)</code></p><ol><li>str: 值（可通过 get_string 获得）</li></ol><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>value</td><td>string</td><td></td></tr><tr><td>type</td><td>string</td><td>如：“kScalar”</td></tr><tr><td>element</td><td></td><td>轉換成ConfigItem</td></tr></tbody></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>get_bool</td><td></td><td></td><td></td></tr><tr><td>get_int</td><td></td><td></td><td></td></tr><tr><td>get_double</td><td></td><td></td><td></td></tr><tr><td>set_bool</td><td></td><td></td><td></td></tr><tr><td>set_int</td><td></td><td></td><td></td></tr><tr><td>set_double</td><td></td><td></td><td></td></tr><tr><td>get_string</td><td></td><td></td><td></td></tr><tr><td>set_string</td><td></td><td></td><td></td></tr></tbody></table><h3 id="configitem" tabindex="-1">ConfigItem <a class="header-anchor" href="#configitem" aria-label="Permalink to &quot;ConfigItem&quot;">​</a></h3><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>type</td><td>string</td><td>1. &quot;kNull&quot; <br> 2. &quot;kScalar&quot; <br> 3. &quot;kList&quot; <br> 4. &quot;kMap&quot;</td></tr><tr><td>empty</td><td></td><td></td></tr></tbody></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>get_value</td><td></td><td></td><td>当 type == &quot;kScalar&quot; 时使用</td></tr><tr><td>get_list</td><td></td><td></td><td>当 type == &quot;kList&quot; 时使用</td></tr><tr><td>get_map</td><td></td><td></td><td>当 type == &quot;kMap&quot; 时使用</td></tr></tbody></table><h3 id="keyevent" tabindex="-1">KeyEvent <a class="header-anchor" href="#keyevent" aria-label="Permalink to &quot;KeyEvent&quot;">​</a></h3><p>按键事件对象。</p><blockquote><p>当按键被按下、释放（release）、保持时均会产生按键事件（KeyEvent），触发 processor，此时 KeyEvent 会被作为第一个参数传递给已注册的 lua_processor。</p></blockquote><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>keycode</td><td>number</td><td>按键值</td></tr><tr><td>modifier</td><td></td><td></td></tr></tbody></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>shift</td><td></td><td>boolean</td><td>触发事件时，是否被按压</td></tr><tr><td>ctrl</td><td></td><td>boolean</td><td>触发事件时，是否被按压</td></tr><tr><td>alt</td><td></td><td>boolean</td><td>触发事件时，是否被按压</td></tr><tr><td>caps <br> （CapsLk）</td><td></td><td>boolean</td><td></td></tr><tr><td>super</td><td></td><td>boolean</td><td></td></tr><tr><td>release</td><td></td><td>boolean</td><td>当事件为“release”时为 true，否则为 false</td></tr><tr><td>repr <br> （representation）</td><td></td><td>string</td><td>当非 release 时，为按键字符，如：“1”、“a”、“space”、“Shift_L” <br> 当 release 时，为Releas+按键字符，如：“Release+space”</td></tr><tr><td>eq(key) <br> （equal）</td><td>key: KeyEvent</td><td>boolean</td><td>两个 KeyEvent 是否“相等”</td></tr><tr><td>lt(key) <br> （less than）</td><td>key: KeyEvent</td><td>boolean</td><td>对象小于参数时为 true</td></tr></tbody></table><h3 id="keysequence" tabindex="-1">KeySequence <a class="header-anchor" href="#keysequence" aria-label="Permalink to &quot;KeySequence&quot;">​</a></h3><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>parse</td><td></td><td></td><td></td></tr><tr><td>repr</td><td></td><td></td><td></td></tr><tr><td>toKeyEvent</td><td></td><td></td><td></td></tr></tbody></table><h3 id="candidate" tabindex="-1">Candidate <a class="header-anchor" href="#candidate" aria-label="Permalink to &quot;Candidate&quot;">​</a></h3><p>（简单的）候选词。（选中后不会更新用户字典）</p><p>构造方法：<code>Candidate(type, start, end, text, comment)</code></p><ol><li>type: 标识</li><li>start: 分词开始</li><li>end: 分词结束</li><li>text: 候选词内容</li><li>comment: 註解</li></ol><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>type</td><td>string</td><td>候选词来源标记，如：“user_phrase”、“phrase”、“punct”、“simplified” <br> 1. &quot;user_phrase&quot;: 用户字典（随用户输入而更新） <br> 2. &quot;phrase&quot; <br> 3. &quot;punct&quot;: 来源有两 &quot;engine/segmentors/punct_segmentor&quot; 或 &quot;symbols:/patch/recognizer/patterns/punct&quot; <br> 4. &quot;simplified&quot; <br> 5. &quot;completion&quot;: 编码未完整。see <a href="https://github.com/rime/librime/blob/69d5c3291745faa184d7c020ce4b394d41744efd/src/rime/gear/table_translator.cc#L77" target="_blank" rel="noreferrer">https://github.com/rime/librime/.../src/rime/gear/table_translator.cc#L77</a> <br> 6...</td></tr><tr><td>start</td><td>number</td><td></td></tr><tr><td>_start</td><td>number</td><td>编码开始位置，如：“好” 在 “ni hao” 中的 _start=2</td></tr><tr><td>_end</td><td>number</td><td>编码结束位置，如：“好” 在 “ni hao” 中的 _end=5</td></tr><tr><td>quality</td><td>number</td><td>结果展示排名权重</td></tr><tr><td>text</td><td>string</td><td>候选词内容</td></tr><tr><td>comment</td><td>string</td><td>註解(name_space/comment_format) <br> <img src="https://user-images.githubusercontent.com/18041500/191151929-6d45e410-ccf8-4676-8146-c64bb3f4393e.png" alt="image"></td></tr><tr><td>preedit</td><td>string</td><td>得到当前候选词的编码（一般空格分开圆音，如：&quot;ni hao&quot;）(name_space/preedit_format)</td></tr></tbody></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>get_dynamic_type</td><td></td><td>string</td><td>1. &quot;Phrase&quot;: Phrase <br> 2. &quot;Simple&quot;: SimpleCandidate （即 Candidate）<br> 3. &quot;Shadow&quot;: ShadowCandidate <br> 4. &quot;Uniquified&quot;: UniquifiedCandidate <br> 5. &quot;Other&quot;</td></tr><tr><td>get_genuine</td><td></td><td>Candidate</td><td></td></tr><tr><td>get_genuines</td><td></td><td>table: <code>&lt;number, Candidate&gt;</code></td><td></td></tr><tr><td>to_shadow_candidate</td><td></td><td></td><td></td></tr><tr><td>to_uniquified_candidate</td><td></td><td></td><td></td></tr><tr><td>append</td><td></td><td></td><td></td></tr></tbody></table><h3 id="uniquifiedcandidate" tabindex="-1">UniquifiedCandidate <a class="header-anchor" href="#uniquifiedcandidate" aria-label="Permalink to &quot;UniquifiedCandidate&quot;">​</a></h3><h3 id="shadowcandidate" tabindex="-1">ShadowCandidate <a class="header-anchor" href="#shadowcandidate" aria-label="Permalink to &quot;ShadowCandidate&quot;">​</a></h3><p>衍生扩展词</p><p><a href="https://github.com/hchunhui/librime-lua/pull/162" target="_blank" rel="noreferrer">https://github.com/hchunhui/librime-lua/pull/162</a></p><p>ShadowCandidate(cand,type,text,comment)類似 simplifier 的作法</p><p>构造方法：<code>ShadowCandidate(cand, type, text, comment, inherit_comment)</code></p><ol><li>cand</li><li>type</li><li>text</li><li>comment</li><li>inherit_comment: （可选）</li></ol><h3 id="phrase" tabindex="-1">Phrase <a class="header-anchor" href="#phrase" aria-label="Permalink to &quot;Phrase&quot;">​</a></h3><p>候选词。（选择后会更新相应的用户字典）</p><p>构造方法：<code>Phrase(memory, type, start, end, entry)</code></p><ol><li>memory: Memory</li><li>type: string</li><li>start: number</li><li>end: number</li><li>entry: DictEntry</li></ol><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>language</td><td></td><td></td></tr><tr><td>type</td><td></td><td></td></tr><tr><td>start</td><td></td><td></td></tr><tr><td>_start</td><td></td><td></td></tr><tr><td>_end</td><td></td><td></td></tr><tr><td>quality</td><td></td><td></td></tr><tr><td>text</td><td></td><td></td></tr><tr><td>comment</td><td></td><td></td></tr><tr><td>preedit</td><td></td><td></td></tr><tr><td>weight</td><td></td><td></td></tr><tr><td>code</td><td></td><td></td></tr><tr><td>entry</td><td></td><td></td></tr></tbody></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>toCandidate</td><td></td><td></td><td></td></tr></tbody></table><h3 id="uniquifiedcandidate-1" tabindex="-1">UniquifiedCandidate <a class="header-anchor" href="#uniquifiedcandidate-1" aria-label="Permalink to &quot;UniquifiedCandidate&quot;">​</a></h3><p><a href="https://github.com/hchunhui/librime-lua/pull/162" target="_blank" rel="noreferrer">https://github.com/hchunhui/librime-lua/pull/162</a></p><p>UniqifiedCandidate(cand,type,text,comment) 類似 uniqifier 的作法</p><h3 id="set" tabindex="-1">Set <a class="header-anchor" href="#set" aria-label="Permalink to &quot;Set&quot;">​</a></h3><p>构造方法：<code>Set(table)</code></p><ol><li>table: 列表</li></ol><p>ex: <code>local set_tab = Set({&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;c&#39;}) # set_tab = {a=true,b=true, c=true}</code></p><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>empty</td><td></td><td></td><td></td></tr><tr><td>__index</td><td></td><td></td><td></td></tr><tr><td>__add</td><td></td><td></td><td></td></tr><tr><td>__sub</td><td></td><td></td><td></td></tr><tr><td>__mul</td><td></td><td></td><td></td></tr><tr><td>__set</td><td></td><td></td><td></td></tr></tbody></table><h3 id="menu" tabindex="-1">Menu <a class="header-anchor" href="#menu" aria-label="Permalink to &quot;Menu&quot;">​</a></h3><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>add_translation</td><td></td><td></td><td></td></tr><tr><td>prepare</td><td></td><td></td><td></td></tr><tr><td>get_candidate_at</td><td></td><td></td><td></td></tr><tr><td>candidate_count</td><td></td><td></td><td></td></tr><tr><td>empty</td><td></td><td></td><td></td></tr></tbody></table><h3 id="opencc" tabindex="-1">Opencc <a class="header-anchor" href="#opencc" aria-label="Permalink to &quot;Opencc&quot;">​</a></h3><p>构造方法：<code>Opencc(filename)</code></p><ol><li>filename: string</li></ol><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>convert</td><td></td><td></td><td></td></tr></tbody></table><h3 id="reversedb-reverselookup" tabindex="-1">ReverseDb /ReverseLookup <a class="header-anchor" href="#reversedb-reverselookup" aria-label="Permalink to &quot;ReverseDb /ReverseLookup&quot;">​</a></h3><p>反查</p><p>构造方法：<code>ReverseDb(file_name)</code></p><ol><li>file_name: 反查字典文件路径。 如: <code>build/terra_pinyin.reverse.bin</code></li></ol><p>e.g.</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pyrdb </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ReverseDb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;build/terra_pinyin.reverse.bin&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>lookup</td><td></td><td></td><td></td></tr></tbody></table><h3 id="reverselookup-ver-177" tabindex="-1">ReverseLookup (ver #177) <a class="header-anchor" href="#reverselookup-ver-177" aria-label="Permalink to &quot;ReverseLookup (ver #177)&quot;">​</a></h3><p>构造方法：<code>ReverseLookup(dict_name)</code></p><ol><li>dict_name: 字典名。 如: <code>luna_pinyin</code></li></ol><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>lookup(key)</td><td>key: string</td><td>string</td><td>如：<code>ReverseLookup(&quot;luna_pinyin&quot;):lookup( &quot;百&quot; ) == &quot;bai bo&quot;</code></td></tr><tr><td>lookup_stems</td><td></td><td></td><td></td></tr></tbody></table><h3 id="commitentry" tabindex="-1">CommitEntry <a class="header-anchor" href="#commitentry" aria-label="Permalink to &quot;CommitEntry&quot;">​</a></h3><p>继承 DictEntry</p><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>get</td><td></td><td></td><td></td></tr></tbody></table><h3 id="dictentry" tabindex="-1">DictEntry <a class="header-anchor" href="#dictentry" aria-label="Permalink to &quot;DictEntry&quot;">​</a></h3><p>构造方法：<code>DictEntry()</code></p><blockquote><p>librime 定义：<a href="https://github.com/rime/librime/blob/ae848c47adbe0411d4b7b9538e4a1aae45352c31/include/rime/impl/vocabulary.h#L33" target="_blank" rel="noreferrer">https://github.com/rime/librime/blob/ae848c47adbe0411d4b7b9538e4a1aae45352c31/include/rime/impl/vocabulary.h#L33</a></p></blockquote><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>text</td><td>string</td><td>词，如：“好”</td></tr><tr><td>comment</td><td>string</td><td>剩下的编码，如：preedit &quot;h&quot;, text &quot;好&quot;, comment &quot;~ao&quot;</td></tr><tr><td>preedit</td><td>string</td><td>如：“h”</td></tr><tr><td>weight</td><td>number</td><td>如：“-13.998352335763”</td></tr><tr><td>commit_count</td><td>number</td><td>如：“2”</td></tr><tr><td>custom_code</td><td>string</td><td>词编码（根据特定规则拆分，以&quot; &quot;（空格）连接，如：拼音中以音节拆分），如：“hao”、“ni hao”</td></tr><tr><td>remaining_code_length</td><td>number</td><td>（预测的结果中）未输入的编码，如：preedit &quot;h&quot;, text &quot;好&quot;, comment &quot;~ao&quot;， remaining_code_length “2”</td></tr><tr><td>code</td><td>Code</td><td></td></tr></tbody></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead></table><h3 id="code" tabindex="-1">Code <a class="header-anchor" href="#code" aria-label="Permalink to &quot;Code&quot;">​</a></h3><p>构造方法：<code>Code()</code></p><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>push(inputCode)</td><td>rime::SyllableId <br> （librime中定义的类型）</td><td></td><td></td></tr><tr><td>print</td><td></td><td>string</td><td></td></tr></tbody></table><h3 id="memory" tabindex="-1">Memory <a class="header-anchor" href="#memory" aria-label="Permalink to &quot;Memory&quot;">​</a></h3><p>提供来操作 dict（字典、固态字典、静态字典）和 user_dict（用户字典、动态字典）的接口</p><p>构造方法：<code>Memory(engine, schema, name_space)</code></p><ol><li>engine: Engine</li><li>schema: Schema</li><li>name_space: string （可选，默认为空）</li></ol><p>e.g.</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">env.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mem</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Memory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(env.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">engine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,env.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">engine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">--  ns= &quot;translator&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- env.mem = Memory(env.engine,env.engine.schema, env.name_space )  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- env.mem = Memory(env.engine,Schema(&quot;cangjie5&quot;) ) --  ns= &quot;translator-</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- env.mem = Memory(env.engine,Schema(&quot;cangjie5&quot;), &quot;translator&quot;)</span></span></code></pre></div><p>构造流程：<a href="https://github.com/rime/librime/blob/3451fd1eb0129c1c44a08c6620b7956922144850/src/gear/memory.cc#L51" target="_blank" rel="noreferrer">https://github.com/rime/librime/blob/3451fd1eb0129c1c44a08c6620b7956922144850/src/gear/memory.cc#L51</a></p><ol><li>加载 schema 中指定的字典（dictionary）<br> （包括：&quot;<code>{name_space}/dictionary</code>&quot;、&quot;<code>{name_space}/prism</code>&quot;、&quot;<code>{name_space}/packs</code>&quot;）</li><li>加在 schema 中指定的用户字典（user_dict）<br> （前提：<code>{name_space}/enable_user_dict</code> 为 true）<br> （包括：&quot;<code>{name_space}/user_dict</code>&quot; 或 &quot;<code>{name_space}/dictionary</code>&quot;）<br> （后缀：&quot;<code>*.userdb.txt</code>&quot;）</li><li>添加通知事件监听（commit_notifier、delete_notifier、unhandled_key_notifier）</li></ol><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>dict_lookup(input, predictive, limit)</td><td>input: string <br> predictive: boolean <br> limit: number</td><td>boolean 是否有结果查询</td><td></td></tr><tr><td>user_lookup(input, predictive)</td><td>input: string <br> predictive: boolean</td><td></td><td></td></tr><tr><td>memorize(callback)</td><td>callback: function <br> （回调参数：CommitEntry）</td><td>当用户字典候选词被选中时触发回调。</td><td></td></tr><tr><td>decode(code)</td><td>code: Code</td><td>table: <code>&lt;number, string&gt;</code></td><td></td></tr><tr><td>iter_dict</td><td></td><td></td><td>配合 <code>for ... end</code> 获得 DictEntry</td></tr><tr><td>iter_user</td><td></td><td></td><td>配合 <code>for ... end</code> 获得 DictEntry</td></tr><tr><td>update_userdict(entry, commits, prefix)</td><td>entry: DictEntry <br> commits: number <br> prefix: string</td><td>boolean</td><td></td></tr></tbody></table><p>使用案例：<a href="https://github.com/hchunhui/librime-lua/blob/67ef681a9fd03262c49cc7f850cc92fc791b1e85/sample/lua/expand_translator.lua#L32" target="_blank" rel="noreferrer">https://github.com/hchunhui/librime-lua/blob/67ef681a9fd03262c49cc7f850cc92fc791b1e85/sample/lua/expand_translator.lua#L32</a></p><p>e.g.</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 遍历</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;hello&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mem </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Memory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(env.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">engine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,env.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">engine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">dict_lookup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 遍历字典</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> entry </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> mem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">iter_dict</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(entry.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">user_lookup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 遍历用户字典</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> entry </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> mem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">iter_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(entry.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 监听 &amp; 更新</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">env.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mem</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Memory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(env.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">engine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, env.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">engine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">env.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">memorize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(commit) </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i,dictentry </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ipairs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">commit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    log.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dictentry.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ..</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot; &quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">..</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dictentry.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">weight</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ..</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot; &quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">..</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dictentry.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">comment</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ..</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- memory:update_userdict(dictentry,0,&quot;&quot;) -- do nothing to userdict</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- memory:update_userdict(dictentry,1,&quot;&quot;) -- update entry to userdict</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- memory:update_userdict(dictentry,-1,&quot;&quot;) -- delete entry to userdict</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    --[[</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      用户字典形式如：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      \`\`\`txt</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # Rime user dictionary</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      #@/db_name	luna_pinyin.userdb</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      #@/db_type	userdb</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      #@/rime_version	1.5.3</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      #@/tick	693</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      #@/user_id	aaaaaaaa-bbbb-4c62-b0b0-ccccccccccc</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      wang shang 	网上	c=1 d=0.442639 t=693</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      wang shi zhi duo shao 	往事知多少	c=1 d=0.913931 t=693</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      wang xia 	往下	c=1 d=0.794534 t=693</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      wei 	未	c=1 d=0.955997 t=693</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      \`\`\`</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    --]]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="projection" tabindex="-1">Projection <a class="header-anchor" href="#projection" aria-label="Permalink to &quot;Projection&quot;">​</a></h3><p>可以用于处理 candidate 的 comment 的转换</p><p>构造：<code>Projection()</code></p><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>load(rules)</td><td>rules: ConfigList</td><td>-</td><td>加载转换规则</td></tr><tr><td>apply(str,[ret_org_str])</td><td>str: string, ret_org_str: bool</td><td>string</td><td>转换字符串: 預設轉換失敗返回 空字串， ret_org_str: true 返回原字串</td></tr></tbody></table><p>使用参考： <a href="https://github.com/hchunhui/librime-lua/pull/102" target="_blank" rel="noreferrer">https://github.com/hchunhui/librime-lua/pull/102</a></p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> config</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">env.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">engine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">config</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- load ConfigList  form  path</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> proedit_fmt_list </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> conifg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">get_list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;translastor/preedit_format&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- create Projection obj</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Projection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- load convert rules</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">p1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">load</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(proedit_fmt_list)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- convert string</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> str_raw </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;abcdefg&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> str_preedit </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> p1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">apply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(str)</span></span></code></pre></div><h3 id="component" tabindex="-1">Component <a class="header-anchor" href="#component" aria-label="Permalink to &quot;Component&quot;">​</a></h3><p>調用 processor,segmentor,translator,filter 組件，可在lua script中再重組。 參考範例: <a href="https://github.com/hchunhui/librime-lua/tree/master/sample/lua/component_test.lua" target="_blank" rel="noreferrer">librime-lua/sample/lua/component_test.lua</a></p><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>Processor</td><td>engine,[schema,]name_space,prescription</td><td>Processor</td><td>如：<code>Component.Processor(env.engine,&quot;&quot;,&quot;ascii_composer&quot;)</code>, <code>Component.Processor(env.engine,Schema(&#39;cangjie5&#39;),&quot;&quot;,&#39;ascii_composer)</code>(使用Schema: cangjie5 config)</td></tr><tr><td>Segmentor</td><td>同上</td><td>Segmentor</td><td></td></tr><tr><td>Translator</td><td>同上</td><td>Translator</td><td>\`Component.Translator(env.engine,&#39;&#39;,&#39;table_translator&#39;)</td></tr><tr><td>Filter</td><td>同上</td><td>Filter</td><td><code>Component.Filter(env.engine,&#39;&#39;,&#39;uniquility&#39;)</code></td></tr></tbody></table><h3 id="processor" tabindex="-1">Processor <a class="header-anchor" href="#processor" aria-label="Permalink to &quot;Processor&quot;">​</a></h3><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>name_space</td><td>string</td><td>取出instance name_space #212</td></tr></tbody></table><p>方法:</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>process_key_event</td><td>KeyEvent</td><td>0-2</td><td>0:kReject 1:kAccepted 2:Noop,<a href="https://github.com/rime/librime/blob/9086de3dd802d20f1366b3080c16e2eedede0584/src/rime/engine.cc#L107-L111" target="_blank" rel="noreferrer">參考engine.cc</a></td></tr></tbody></table><h3 id="segmentator" tabindex="-1">Segmentator <a class="header-anchor" href="#segmentator" aria-label="Permalink to &quot;Segmentator&quot;">​</a></h3><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>name_space</td><td>string</td><td>取出instance name_space #212</td></tr></tbody></table><p>方法:</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>proceed</td><td>Segmentation</td><td>bool</td><td><a href="https://github.com/rime/librime/blob/9086de3dd802d20f1366b3080c16e2eedede0584/src/rime/engine.cc#L168" target="_blank" rel="noreferrer">參考engine.cc</a></td></tr></tbody></table><h3 id="translator" tabindex="-1">Translator <a class="header-anchor" href="#translator" aria-label="Permalink to &quot;Translator&quot;">​</a></h3><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>name_space</td><td>string</td><td>取出instance name_space #212</td></tr></tbody></table><p>方法:</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>query</td><td>string: input, segmet</td><td>Translation <a href="https://github.com/rime/librime/blob/9086de3dd802d20f1366b3080c16e2eedede0584/src/rime/engine.cc#L189-L218" target="_blank" rel="noreferrer">參考engine.cc</a></td><td></td></tr></tbody></table><h3 id="filter" tabindex="-1">Filter <a class="header-anchor" href="#filter" aria-label="Permalink to &quot;Filter&quot;">​</a></h3><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>name_space</td><td>string</td><td>取出instance name_space #212</td></tr></tbody></table><p>方法:</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>apply</td><td>translation,cands</td><td>Translation</td><td><a href="https://github.com/rime/librime/blob/9086de3dd802d20f1366b3080c16e2eedede0584/src/rime/engine.cc#L189-L218" target="_blank" rel="noreferrer">參考engine.cc</a></td></tr></tbody></table><h3 id="notifier" tabindex="-1">Notifier <a class="header-anchor" href="#notifier" aria-label="Permalink to &quot;Notifier&quot;">​</a></h3><p>接收通知</p><p>通知类型：</p><ol><li>commit_notifier</li><li>select_notifier</li><li>update_notifier</li><li>delete_notifier</li></ol><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead></table><p>方法： notifier connect</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>connect(func[,group])</td><td>func: function grup: int</td><td>Notifier 新增 group 依 gorup 順序通知 0,1,...connect(func) 排在最後)</td><td></td></tr></tbody></table><p>e.g.</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- ctx: Context</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">env.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">engine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">commit_notifier</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">connect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- your code ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="optionupdatenotifier" tabindex="-1">OptionUpdateNotifier <a class="header-anchor" href="#optionupdatenotifier" aria-label="Permalink to &quot;OptionUpdateNotifier&quot;">​</a></h3><p>同 Notifier</p><p>e.g.</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- ctx: Context</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- name: string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">env.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">engine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">option_update_notifier</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">connect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, name)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- your code ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="propertyupdatenotifier" tabindex="-1">PropertyUpdateNotifier <a class="header-anchor" href="#propertyupdatenotifier" aria-label="Permalink to &quot;PropertyUpdateNotifier&quot;">​</a></h3><p>同 Notifier</p><p>e.g.</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- ctx: Context</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- name: string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">env.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">engine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">property_update_notifier</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">connect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, name)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- your code ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="keyeventnotifier" tabindex="-1">KeyEventNotifier <a class="header-anchor" href="#keyeventnotifier" aria-label="Permalink to &quot;KeyEventNotifier&quot;">​</a></h3><p>同 Notifier</p><p>e.g.</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- ctx: Context</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- key: KeyEvent</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">env.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">engine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unhandled_key_notifier</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">connect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, key)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- your code ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="connection" tabindex="-1">Connection <a class="header-anchor" href="#connection" aria-label="Permalink to &quot;Connection&quot;">​</a></h3><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>disconnect</td><td></td><td></td><td></td></tr></tbody></table><h3 id="log" tabindex="-1">log <a class="header-anchor" href="#log" aria-label="Permalink to &quot;log&quot;">​</a></h3><p>记录日志到日志文件</p><p>日志位置：<a href="https://github.com/rime/home/wiki/RimeWithSchemata#%E9%97%9C%E6%96%BC%E8%AA%BF%E8%A9%A6" target="_blank" rel="noreferrer">https://github.com/rime/home/wiki/RimeWithSchemata#關於調試</a></p><ul><li>【中州韻】 <code>/tmp/rime.ibus.*</code></li><li>【小狼毫】 <code>%TEMP%\\rime.weasel.*</code></li><li>【鼠鬚管】 <code>$TMPDIR/rime.squirrel.*</code></li><li>各發行版的早期版本 <code>用戶資料夾/rime.log</code></li></ul><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>info</td><td></td><td></td><td></td></tr><tr><td>warning</td><td></td><td></td><td></td></tr><tr><td>error</td><td></td><td></td><td></td></tr></tbody></table><h3 id="rime-api" tabindex="-1">rime_api <a class="header-anchor" href="#rime-api" aria-label="Permalink to &quot;rime_api&quot;">​</a></h3><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>get_rime_version</td><td></td><td>string</td><td>librime 版本</td></tr><tr><td>get_shared_data_dir</td><td></td><td>string</td><td>程序目录\\data</td></tr><tr><td>get_user_data_dir</td><td></td><td>string</td><td>用户目录</td></tr><tr><td>get_sync_dir</td><td></td><td>string</td><td>用户资料同步目录</td></tr><tr><td>get_distribution_name</td><td></td><td>string</td><td>如：“小狼毫”</td></tr><tr><td>get_distribution_code_name</td><td></td><td>string</td><td>如：“Weasel”</td></tr><tr><td>get_distribution_version</td><td></td><td>string</td><td>发布版本号</td></tr><tr><td>get_user_id</td><td></td><td></td><td></td></tr></tbody></table><h3 id="commitrecord" tabindex="-1">CommitRecord <a class="header-anchor" href="#commitrecord" aria-label="Permalink to &quot;CommitRecord&quot;">​</a></h3><p>CommitRecord : 參考 librime/src/rime/ engine.cc commit_history.h</p><ul><li>commit_text =&gt; <code>{type: &#39;raw&#39;, text: string}</code></li><li>commit =&gt; <code>{type: cand.type, text: cand.text}</code></li><li>reject =&gt; <code>{type: &#39;thru&#39;, text: ascii code}</code></li></ul><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>type</td><td>string</td><td></td></tr><tr><td>text</td><td>string</td><td></td></tr></tbody></table><h3 id="commithistory" tabindex="-1">CommitHistory <a class="header-anchor" href="#commithistory" aria-label="Permalink to &quot;CommitHistory&quot;">​</a></h3><p>engine 在 commit commit_text 會將 資料存入 commit_history, reject且屬於ascii範圍時存入ascii 此api 除了可以取出 CommitRecord 還可以在lua中推入commit_record 參考: librime/src/rime/gear/history_translator</p><p>属性：</p><table><thead><tr><th>属性名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>size</td><td>number</td><td>max_size &lt;=20</td></tr></tbody></table><p>方法：</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>push</td><td>(KeyEvent),(composision,ctx.input)(cand.type,cand.text)</td><td></td><td>推入 CommitRecord</td></tr><tr><td>back</td><td></td><td>CommitRecord</td><td>取出最後一個 CommitRecord</td></tr><tr><td>to_table</td><td></td><td>lua table of CommitRecord</td><td>轉出 lua table of CommitRecord</td></tr><tr><td>iter</td><td></td><td></td><td>reverse_iter</td></tr><tr><td>repr</td><td></td><td>string</td><td>格式 [type]text[type]text....</td></tr><tr><td>latest_text</td><td></td><td>string</td><td>取出最後一個CommitRecord.text</td></tr><tr><td>empty</td><td></td><td>bool</td><td></td></tr><tr><td>clear</td><td></td><td></td><td>size=0</td></tr><tr><td>pop_back</td><td></td><td></td><td>移除最後一個CommitRecord</td></tr></tbody></table><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 將comit cand.type == &quot;table&quot; 加入 translation</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(inp,seg,env)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> not</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seg.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">has_tag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;histroy&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> r_iter,commit_record </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">commit_history</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">iter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> commit_record.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;table&quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">       yield</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">( </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Candidate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">( commit_record.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,seg.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,seg.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">_end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,commit_record.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;commit_history&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> T</span></span></code></pre></div><h3 id="dbassessor" tabindex="-1">DbAssessor <a class="header-anchor" href="#dbassessor" aria-label="Permalink to &quot;DbAssessor&quot;">​</a></h3><p>支援 leveldb:query(prefix_key)</p><p>methods: obj of LevelDb</p><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>reset</td><td>none</td><td>bool</td><td>jump to begin</td></tr><tr><td>jump</td><td>prefix of key:string</td><td>bool</td><td>jump to first of prefix_key</td></tr><tr><td>iter</td><td>none</td><td>iter_func,self</td><td>範例: for k,v in da:iter() do print(k,v) end</td></tr></tbody></table><h3 id="leveldb-不可用於已開啓的userdb-專用於-librime-lua-key-value-db" tabindex="-1">LevelDb ( 不可用於已開啓的userdb, 專用於 librime-lua key-value db) <a class="header-anchor" href="#leveldb-不可用於已開啓的userdb-專用於-librime-lua-key-value-db" aria-label="Permalink to &quot;LevelDb ( 不可用於已開啓的userdb, 專用於 librime-lua key-value db)&quot;">​</a></h3><p>便於調用大型資料庫且不佔用 lua 動態記憶</p><h4 id="新建-leveldb" tabindex="-1">新建 leveldb <a class="header-anchor" href="#新建-leveldb" aria-label="Permalink to &quot;新建 leveldb&quot;">​</a></h4><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>LevelDb</td><td>dbname:string</td><td>obj of LevelDb</td><td>local db = LevelDb(&#39;ecdict&#39;) -- opendb :user_data_dir/ecdict</td></tr></tbody></table><h4 id="物件方法" tabindex="-1">物件方法 <a class="header-anchor" href="#物件方法" aria-label="Permalink to &quot;物件方法&quot;">​</a></h4><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>open</td><td>none</td><td>bool</td><td></td></tr><tr><td>open_read_only</td><td>none</td><td>bool</td><td>禁用 earse ,update</td></tr><tr><td>close</td><td>none</td><td>bool</td><td></td></tr><tr><td>loaded</td><td>none</td><td>bool</td><td></td></tr><tr><td>query</td><td>prefix of key:string</td><td>obj of DbAccessor</td><td>查找 prefix key</td></tr><tr><td>fetch</td><td>key:string</td><td>value:string or nil</td><td>查找 value</td></tr><tr><td>update</td><td>key:string,value:string</td><td>bool</td><td></td></tr><tr><td>erase</td><td>key:string</td><td>bool</td><td></td></tr></tbody></table><p>範例：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> -- 建議加入 db_pool 可避免無法開啓已開啓DB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _db_pool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _db_pool </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">or</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> local</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> wrapLevelDb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dbname,mode)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   _db_pool[dbname] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _db_pool[dbname] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">or</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> LevelDb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dbname)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> db </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _db_pool[dbname]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> db </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">and</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> not</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> db</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">loaded</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mode </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        db</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">open</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        db</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">open_read_only</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> db</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> db </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> wrapLevelDb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ecdict&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- open_read_only</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> -- local db = wrapLevelDb(&#39;ecdictu&#39;,true) -- open</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> da </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> db</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;the&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- return obj of DbAccessor</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> k,v </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> da</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">iter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(k,v) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div>`,373),n=[d];function h(l,p,r,k,o,c){return i(),s("div",null,n)}const E=t(e,[["render",h]]);export{y as __pageData,E as default};
